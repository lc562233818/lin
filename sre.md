# SRE
## 认知SRE
**SRE主要分为两个指标**
* MTBF，Mean Time Between Failure，平均故障时间间隔，MTBF系统正常运行的阶段
* MTTR，Mean Time To Repair， 故障平均修复时间，MTTR则意味着系统故障状态
**MTTR又分四个指标**
* MTTI平均故障发现时间，从故障实际发生，到我们真正开始响应时间
* MTTK平均故障认知时间，根因定位定位时间
* MTTF平均故障解决时间，根据根因，采取措施恢复业务为止
* MTTV平均故障修复验证时间，故障解决后，通过验证确认业务真正恢复所用时间
## 系统可用性
**衡量系统可用性的两种方式**
* 时间维度：Availability = Uptime / (Uptime + Downtime)（时长维度，是从故障角度出发对系统稳定性进行评估）
```
从时间维度测量和判定方法主要包含三个因素
1、衡量指标，以交易请求为单位
2、衡量目标：比如，系统请求状态码为非 5xx 的比例数量，也就是请求成功率低于 95%，已经连续超过10分钟，这时就设置为一个一级故障
3、影响时长：系统请求状态码；衡量目标，非 5xx 占比，也就是成功率达到 95%；影响时长，持续10分钟
```
* 请求维度：Availability = Successful request / Total request
**系统可用性对比表**
<img width="512" alt="image" src="https://user-images.githubusercontent.com/33318891/156274875-dd83ebdd-8745-464b-912e-c74c73256daf.png">
## 切入SRE
**SRE 中就是设定稳定性衡量标准的 SLI 和 SLO 的过程**
* SLI就是设置一种指标，例如请求状态是否与预期值一直例如非5xx
常见SLI系统指标
<img width="502" alt="image" src="https://user-images.githubusercontent.com/33318891/156274935-ac82df16-159f-4ea2-84d5-25a81814c124.png">
**SLI指标坚持两大原则**
```
1、选择能够标识一个主体是否稳定的指标，如果不是这个主体本身的指标，或者不能
标识主体稳定性的，就要排除在外
2、针对电商这类有用户界面的业务系统，优先选择与用户体验强相关或用户可以明显
感知的指标
```
**快速识别SLI指标的方法 VALET**
```
1、Volume- 容量：Volume（容量）是指服务承诺的最大容量是多少。比如，一个应用集群的 QPS、TPS、会话数以及连接数等等，如果我们对日常设定一个目标，就是日常的容量 SLO
2、Availablity- 可用性
Availablity（可用性）代表服务是否正常。比如，我们前面介绍到的请求调用的非 5xx 状
态码成功率，就可以归于可用性。对于交易平台，我们就看交易的请求状态码，这个也可
以根据不同的任务执行状态码来归类。
3、Latency- 时延Latency（时延）是说响应是否足够快。这是一个会直接影响用户访问体验的指标。
4、Errors- 错误率错误率有多少？这里除了 5xx 之外，我们还可以把 4xx 列进来，因为前面我们的服务可用性不错，但是从业务和体验角度，4xx 太多，用户也是不能接受的。
Tickets- 人工介入 如果设置了一个错误总数，在一个时间段达到了这个错误总数，那也是不达标需要人工介入
```
* SLO就是总数是否达到你设置的阈值，例如99.999%
## 错误预算
**故障定级**
<img width="534" alt="image" src="https://user-images.githubusercontent.com/33318891/156274956-b78adb99-7827-428e-acd1-ac51cf47b00e.png">
* 可以将故障定为几个等级，设置一个总数错误预算当你的错误一个周期内在某个时间段错误预算消耗了20%以上，可以给一个故障等级
* 错误预算还可指定最大允许犯错次数，例如驾驶证一年总共12分，扣完了就失效，同样也适用于平台，可根据这个给平台进行故障定级与每个等级最大犯错次数
* 比如4周的一个周期内，如果错误预算没有被消耗完，我们强调即使出现一些问题，甚至是故障，我们是要容忍的，比如，网络抖动或设备瞬时切换导致了极短暂的系统不稳定
* 剩余预算消耗过快或即将消耗完之前，SRE有权中止和拒绝任何线上变更，因为此时系统已经达到瓶颈若现在线上变更操作可能会发生雪崩效应
**基于错误预算的告警**
```
1、比如同一应用集群内同一时间内，同一异常告警，就先合并，对外只发送一条，这种比较简单直接
2、基于错误预算来做告警，也就是说我们只关注对稳定性造成影响的告警，比如
我们前面提到的，当单次问题消耗的错误预算达到 20% 或 30% 等某一阈值时，就意味着问题非常严重了，这种告警信息一旦收到，就要马上做出响应
```
## 落地SLO
* 需要从核心与非核心应用之间做区分，对于核心应用来说需要保持请求高成功率
* 非核心应用就可以采用服务治理功能实现
```
因现在都是分布式系统应用，例如在双11期间，用户的购买商品目的性应该是比较明确的，那么对于商品评价这块应用是没有那么关注的，那么也可以适当对该应用进行降级操作，当然这个需要分析日志看那块应用请求次数较高，较低来区分核心应用与非核心应用
```
**设计SLO的原则**
```
1、核心应用的 SLO 要更严格，非核心应用可以放宽。 这么做，就是为了确保 SRE 的精力能够更多地关注在核心业务上
2、第二，强依赖之间的核心应用，SLO 要一致 比如下单的 购买 应用要依赖 优惠券 这个促销应用，我们要求下单成功率的 SLO 要 99.95%，如果 Coupon 只有 99.9%
3、弱依赖中，核心应用对非核心的依赖，要有降级、熔断和限流等服务治理手段，这样做是为了避免由非核心应用的异常而导致核心应用 SLO 不达标
```
**容量压测**
```
容量压测的主要作用，就是看 SLO 中的 Volume，也就是容量目标
是否可以达成。对于一般的业务系统，我们都会用 QPS 和 TPS 来表示系统容量，得到了容量这个指标，你就可以在平时观察应用或系统运行的容量水位情况，比如，我们设定容量的SLO 是 5000 QPS，如果日常达到 4500，也就是 SLO 的 90%，我们认为这个水位状态下，就要启动扩容，提前应对更大的访问流量
```
**混沌工程**
* 其实混沌工程也是一个非常复杂的系统化工程，因为要在线上制造故障，或多或少都要对线上业务造成影响，如果模拟故障造成的真实影响超过了预估影响，也要能够快速隔离，并快速恢复正常业务
## OnCall流程
* 确保关键角色在线，整个产品体系中的所有关键角色
* 组织War Room应急组织，当有故障发生时会第一时间在消防群通报，这时对应的 On-Call 同事就要第一时间最高优先级响应呼叫（Page）
* 建立合理的呼叫方式
* 确保资源投入的升级机制
## 故障复盘
* 健壮性原则
* 第三方默认无责
* 分段判定原则
